<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#1976d2" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Paludario" />
<meta name="description" content="Gestione completa del paludario - Valori acqua, programmazione luci e sistemi" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="msapplication-TileColor" content="#1976d2" />
<meta name="msapplication-tap-highlight" content="no" />

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Paludario&quot;,&quot;short_name&quot;:&quot;Paludario&quot;,&quot;description&quot;:&quot;Gestione completa del paludario&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#1976d2&quot;,&quot;orientation&quot;:&quot;portrait&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxOTc2ZDIiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},{&quot;src&quot;:&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iNjQiIGZpbGw9IiMxOTc2ZDIiLz4KPHN2ZyB4PSIxMjgiIHk9IjEyOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xMiAyTDEzLjA5IDguMjZMMjAgOUwxMy4wOSAxNS43NEwxMiAyMkwxMC45MSAxNS43NEw0IDlMMTAuOTEgOC4yNkwxMiAyWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPg==&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}" />

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxOTc2ZDIiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+" />
<link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjIiIGZpbGw9IiMxOTc2ZDIiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+" />

<title>Paludario - Standalone</title>
<style>
	/* Mobile-first CSS ottimizzato */
	body { 
		font-family: system-ui, Arial, sans-serif; 
		margin: 12px; 
		-webkit-text-size-adjust: 100%;
		-webkit-tap-highlight-color: transparent;
	}
	
	/* Pulsanti touch-friendly */
	button { 
		cursor: pointer; 
		min-height: 44px;
		min-width: 44px;
		padding: 12px 16px;
		font-size: 16px;
		border-radius: 8px;
		border: 1px solid #ddd;
		background: #f8f9fa;
		transition: all 0.2s;
	}
	button:hover {
		background: #e9ecef;
		transform: translateY(-1px);
	}
	button:active {
		transform: translateY(0);
	}
	
	/* Layout responsive */
	.grid-2 { display: grid; grid-template-columns: 1fr; gap: 16px; }
	.row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 16px 0; }
	.field { display: flex; align-items: center; gap: 8px; }
	.field label { min-width: 60px; font-weight: bold; }
	.field input, .field select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
	.field .unit { background: #e9ecef; padding: 8px 12px; border-radius: 4px; font-size: 14px; }
	
	/* Tabelle responsive */
	table { width: 100%; border-collapse: collapse; margin: 16px 0; }
	th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
	th { background: #f8f9fa; font-weight: bold; }
	
	/* Canvas responsive */
	canvas { width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 8px; }
	
	/* Status indicator */
	.status-indicator {
		position: fixed;
		top: 10px;
		right: 10px;
		background: #4caf50;
		color: white;
		padding: 8px 16px;
		border-radius: 20px;
		font-size: 14px;
		font-weight: bold;
		box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		z-index: 1000;
	}
	
	/* Dark mode styles */
	.dark-mode {
		background-color: #1a1a1a !important;
		color: #ffffff !important;
	}
	.dark-mode th {
		background: #333 !important;
		color: #ffffff !important;
	}
	.dark-mode fieldset {
		border-color: #555 !important;
	}
	.dark-mode legend {
		color: #ffffff !important;
	}
	.dark-mode .unit {
		background: #444 !important;
		color: #ccc !important;
		border-color: #666 !important;
	}
	.dark-mode input, .dark-mode select {
		background: #333 !important;
		color: #ffffff !important;
		border-color: #555 !important;
	}
	.dark-mode canvas {
		background: #222 !important;
		border-color: #555 !important;
	}
	.dark-mode button {
		background: #444 !important;
		color: #ffffff !important;
		border-color: #666 !important;
	}
	.dark-mode button:hover {
		background: #555 !important;
	}
	
	/* Stili per il titolo editabile */
	#main-title:hover {
		border-color: #ddd !important;
	}
	#main-title:focus {
		border-color: #1976d2 !important;
		outline: none;
		background: rgba(25, 118, 210, 0.05);
	}
	.dark-mode #main-title:hover {
		border-color: #666 !important;
	}
	.dark-mode #main-title:focus {
		border-color: #64b5f6 !important;
		background: rgba(100, 181, 246, 0.1);
	}
	
	/* Responsive design */
	@media (min-width: 768px) {
		body { margin: 18px; }
		.grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
		input[type="number"] { width: 90px; }
		input[type="time"] { width: 100px; }
		input[type="datetime-local"] { width: 210px; }
		canvas { height: 190px; }
	}
	
	/* Safe area per iPhone X e successivi */
	@supports (padding: max(0px)) {
		body {
			padding-left: max(12px, env(safe-area-inset-left));
			padding-right: max(12px, env(safe-area-inset-right));
		}
	}
</style>
</head>
<body>

<div style="position: fixed; top: 10px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
	<div id="status-indicator" class="status-indicator" style="position: static; background: #4caf50; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; box-shadow: none; margin: 0;">‚úÖ App Standalone</div>
	<div style="display: flex; gap: 8px; align-items: center;">
		<button id="dark-mode-toggle" style="background: #333; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; min-height: 44px;">üåô Dark Mode</button>
	</div>
	<div id="last-sync" style="font-size: 11px; color: #666; text-align: right; max-width: 200px; line-height: 1.3;"></div>
</div>

<div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 16px;">
	<h1 id="main-title" contenteditable="true" style="cursor: pointer; border: 2px solid transparent; padding: 8px; border-radius: 8px; transition: border-color 0.2s; margin: 0; font-size: 28px;">üå± Paludario</h1>
	<div class="field">
		<label>üíß Litri</label>
		<input id="liters" type="number" min="0" step="0.1" placeholder="0" />
	</div>
</div>

<fieldset>
	<legend>üíß Valori Acqua</legend>
	<div class="row">
		<div class="field">
			<label>üìÖ Data/Ora</label>
			<input id="water-dt" type="datetime-local" />
		</div>
		<div class="field">
			<label>pH</label>
			<input id="ph" type="number" min="0" max="14" step="0.1" placeholder="7.0" />
		</div>
		<div class="field">
			<label>KH</label>
			<input id="kh" type="number" min="0" step="0.1" placeholder="4.0" />
		</div>
		<div class="field">
			<label>GH</label>
			<input id="gh" type="number" min="0" step="0.1" placeholder="6.0" />
		</div>
		<div class="field">
			<label>NO‚ÇÇ</label>
			<input id="no2" type="number" min="0" step="0.1" placeholder="0.0" />
		</div>
		<div class="field">
			<label>NO‚ÇÉ</label>
			<input id="no3" type="number" min="0" step="0.1" placeholder="5.0" />
		</div>
		<div class="field">
			<label>NH‚ÇÑ</label>
			<input id="nh4" type="number" min="0" step="0.1" placeholder="0.0" />
		</div>
		<div class="field">
			<label>üå°Ô∏è Temp</label>
			<input id="temp" type="number" min="0" step="0.1" placeholder="24.0" />
			<span class="unit">¬∞C</span>
		</div>
		<div class="field">
			<label>‚ö° Cond</label>
			<input id="cond" type="number" min="0" step="1" placeholder="300" />
			<span class="unit">ŒºS/cm</span>
		</div>
		<button id="add-water">‚ûï Aggiungi</button>
		<button id="clear-water">üßπ Pulisci</button>
	</div>
	<table id="water-table">
		<thead>
			<tr><th>üìÖ Data/Ora</th><th>pH</th><th>KH</th><th>GH</th><th>NO‚ÇÇ</th><th>NO‚ÇÉ</th><th>NH‚ÇÑ</th><th>üå°Ô∏è Temp</th><th>‚ö° Cond</th><th>‚öôÔ∏è Azioni</th></tr>
		</thead>
		<tbody></tbody>
	</table>
</fieldset>

<canvas id="waterChart"></canvas>
<div class="legend" id="waterLegend"></div>

<script>
// Configurazione GitHub inline per evitare problemi CORS
const GITHUB_CONFIG = {
    username: 'Tia2694',
    repository: 'Paludario',
    branch: 'main',
    token: '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'
};

// API Base
const API_BASE = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}`;

// Dati dell'app
let waterData = [];
let settings = { 
    title: 'üå± Paludario', 
    liters: '', 
    darkMode: false,
    waterThresholds: {
        ph: { min: 6.0, max: 8.0 },
        kh: { min: 2.0, max: 15.0 },
        gh: { min: 3.0, max: 20.0 },
        no2: { min: 0.0, max: 0.5 },
        no3: { min: 0.0, max: 50.0 },
        nh4: { min: 0.0, max: 0.5 },
        temp: { min: 20.0, max: 30.0 },
        cond: { min: 100, max: 1000 }
    }
};

// Elementi UI
const statusEl = document.getElementById('status-indicator');
const mainTitle = document.getElementById('main-title');
const litersInput = document.getElementById('liters');
const waterDt = document.getElementById('water-dt');
const ph = document.getElementById('ph');
const kh = document.getElementById('kh');
const gh = document.getElementById('gh');
const no2 = document.getElementById('no2');
const no3 = document.getElementById('no3');
const nh4 = document.getElementById('nh4');
const temp = document.getElementById('temp');
const cond = document.getElementById('cond');
const addWaterBtn = document.getElementById('add-water');
const clearWaterBtn = document.getElementById('clear-water');
const waterTableBody = document.querySelector('#water-table tbody');
const darkModeToggle = document.getElementById('dark-mode-toggle');

// Funzioni di utilit√†
function updateStatus(message, type = 'success') {
    statusEl.textContent = message;
    statusEl.className = `status-indicator ${type}`;
}

function nonNeg(v) {
    if (v === '' || v == null) return null;
    const n = Number(v);
    if (!isFinite(n)) return null;
    return Math.max(0, n);
}

function fmtDateTimeLocal(dtStr) { 
    const d = new Date(dtStr); 
    return isNaN(d) ? (dtStr || '') : d.toLocaleString(); 
}

// Funzioni di salvataggio (solo locale per standalone)
function saveToLocalStorage() {
    localStorage.setItem('paludario.waterReadings', JSON.stringify(waterData));
    localStorage.setItem('paludario.title', settings.title);
    localStorage.setItem('paludario.liters', settings.liters);
    localStorage.setItem('paludario.darkMode', settings.darkMode);
    localStorage.setItem('paludario.waterThresholds', JSON.stringify(settings.waterThresholds));
}

function loadFromLocalStorage() {
    waterData = JSON.parse(localStorage.getItem('paludario.waterReadings') || '[]');
    settings.title = localStorage.getItem('paludario.title') || 'üå± Paludario';
    settings.liters = localStorage.getItem('paludario.liters') || '';
    settings.darkMode = localStorage.getItem('paludario.darkMode') === 'true';
    
    const savedThresholds = localStorage.getItem('paludario.waterThresholds');
    if (savedThresholds) {
        settings.waterThresholds = JSON.parse(savedThresholds);
    }
}

// Funzioni dell'app
function addWaterValue() {
    const ts = waterDt.value;
    if (!ts) {
        alert('Inserisci data e ora');
        return;
    }
    
    const values = {
        id: Date.now().toString(),
        ts: ts,
        ph: nonNeg(ph.value),
        kh: nonNeg(kh.value),
        gh: nonNeg(gh.value),
        no2: nonNeg(no2.value),
        no3: nonNeg(no3.value),
        nh4: nonNeg(nh4.value),
        temp: nonNeg(temp.value),
        cond: nonNeg(cond.value)
    };
    
    waterData.push(values);
    renderWaterTable();
    saveToLocalStorage();
    updateStatus('‚úÖ Valore aggiunto', 'success');
}

function clearWaterInputs() {
    waterDt.value = '';
    ph.value = '';
    kh.value = '';
    gh.value = '';
    no2.value = '';
    no3.value = '';
    nh4.value = '';
    temp.value = '';
    cond.value = '';
}

function renderWaterTable() {
    if (!waterTableBody) return;
    
    waterTableBody.innerHTML = '';
    waterData.forEach(w => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${fmtDateTimeLocal(w.ts)}</td>
            <td>${w.ph || '-'}</td>
            <td>${w.kh || '-'}</td>
            <td>${w.gh || '-'}</td>
            <td>${w.no2 || '-'}</td>
            <td>${w.no3 || '-'}</td>
            <td>${w.nh4 || '-'}</td>
            <td>${w.temp ? w.temp + '¬∞C' : '-'}</td>
            <td>${w.cond ? w.cond + ' ŒºS/cm' : '-'}</td>
            <td><button onclick="deleteWater('${w.id}')">üóëÔ∏è</button></td>
        `;
        waterTableBody.appendChild(tr);
    });
}

function deleteWater(id) {
    waterData = waterData.filter(w => w.id !== id);
    renderWaterTable();
    saveToLocalStorage();
}

// Event listeners
mainTitle.addEventListener('blur', () => {
    settings.title = mainTitle.textContent;
    saveToLocalStorage();
});

litersInput.addEventListener('input', () => {
    if (litersInput.value !== '' && Number(litersInput.value) < 0) {
        litersInput.value = 0;
    }
    settings.liters = litersInput.value;
    saveToLocalStorage();
});

addWaterBtn.onclick = addWaterValue;
clearWaterBtn.onclick = clearWaterInputs;

// Dark mode toggle
if (darkModeToggle) {
    darkModeToggle.onclick = () => {
        settings.darkMode = !settings.darkMode;
        document.body.classList.toggle('dark-mode', settings.darkMode);
        darkModeToggle.textContent = settings.darkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        darkModeToggle.style.background = settings.darkMode ? '#555' : '#333';
        saveToLocalStorage();
    };
}

// Inizializza app
document.addEventListener('DOMContentLoaded', () => {
    // Carica dati locali
    loadFromLocalStorage();
    
    // Aggiorna UI
    mainTitle.textContent = settings.title;
    litersInput.value = settings.liters;
    
    if (settings.darkMode) {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = '‚òÄÔ∏è Light Mode';
        darkModeToggle.style.background = '#555';
    }
    
    // Imposta data/ora corrente
    if (waterDt) {
        const d = new Date();
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        waterDt.value = d.toISOString().slice(0, 16);
    }
    
    // Renderizza tabella
    renderWaterTable();
    
    updateStatus('‚úÖ App caricata (modalit√† standalone)', 'success');
});

// Input validation per valori negativi
[ph, kh, gh, no2, no3, nh4, temp, cond].forEach(inp => {
    if (inp) {
        inp.addEventListener('input', () => {
            if (inp.value !== '') {
                const n = Number(inp.value);
                if (isFinite(n) && n < 0) inp.value = 0;
            }
        });
    }
});
</script>
</body>
</html>
